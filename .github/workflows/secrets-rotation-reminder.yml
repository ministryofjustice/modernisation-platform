---
name: Secrets Rotation Reminder
on:
  pull_request:
    branches:
      - "main" 
    paths:
      - ".github/workflows/secrets-rotation-reminder.yml"
  schedule: 
      - cron: '30 11 * * *' # run at 11:30 daily 
  workflow_dispatch:

env:
    AWS_REGION: "eu-west-2"
    SECRET: ${{ secrets.GITHUB_TOKEN }}
    RATE_THRESHOLD: 100
    APP_ID: 2013696
    
permissions:
    id-token: write # This is required for requesting the JWT
    contents: read # This is required for actions/checkout
    issues: write # This is required to create issues
    
defaults:
    run:
        shell: bash

jobs:

  fetch-secrets:
    uses: ministryofjustice/modernisation-platform-github-actions/.github/workflows/aws-secrets-management.yml@0c879ebf9183dd7e47d3fe9c961afa3271843b8b # v3.6.0
    secrets:
      MODERNISATION_PLATFORM_ACCOUNT_NUMBER: ${{ secrets.MODERNISATION_PLATFORM_ACCOUNT_NUMBER }}
      PASSPHRASE: ${{ secrets.PASSPHRASE }}  

  secrets-rotation-reminder:
      runs-on: ubuntu-latest
      needs: fetch-secrets
      steps:
        - name: Checkout Repository
          uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

        - name: Decrypt Secrets
          uses: ministryofjustice/modernisation-platform-github-actions/decrypt-secrets@0c879ebf9183dd7e47d3fe9c961afa3271843b8b # v3.6.0
          with:
            environment_management: ${{ needs.fetch-secrets.outputs.environment_management }}
            mp_github_app_private_key: ${{ needs.fetch-secrets.outputs.mp_github_app_private_key }}
            PASSPHRASE: ${{ secrets.PASSPHRASE }}

        - name: Create GitHub App token
          id: app
          uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
          with:
            app-id: ${{ env.APP_ID }}               
            private-key: ${{ env.MP_GITHUB_APP_PRIVATE_KEY }} 
            owner: "ministryofjustice"
            repositories: "modernisation-platform"

        - name: Authenticate GitHub CLI as the App and Check the Rate Usage
          env:
            GH_TOKEN: ${{ steps.app.outputs.token }}
          run: |
            # gh automatically uses GH_TOKEN if set â€” no `gh auth login` needed
            gh auth status
            bash ./scripts/check-github-api-usage.sh

        - name: Set Account Number
          run: |
            ACCOUNT_NUMBER=$(jq -r -e '.modernisation_platform_account_id' <<< $ENVIRONMENT_MANAGEMENT)
            echo "::add-mask::$ACCOUNT_NUMBER"
            echo ACCOUNT_NUMBER=$ACCOUNT_NUMBER >> $GITHUB_ENV
  
        - name: Configure AWS Credentials
          uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708 # v5.1.1
          with:
            role-to-assume: "arn:aws:iam::${{ env.ACCOUNT_NUMBER }}:role/github-actions-apply"
            role-session-name: githubactionsrolesession
            aws-region: ${{ env.AWS_REGION }}
  
        - name: Run Secrets Rotation Reminder Script
          env:
            GH_TOKEN: ${{ steps.app.outputs.token }}
          run: |
            # Get the list of secret names from AWS Secrets Manager
            secrets=$(aws secretsmanager list-secrets --region $AWS_REGION --query "SecretList[].Name" --output text)
            
            # Remove secrets from list that are exempt from rotation
            delete=("environment_management" "nuke_account_ids" "nuke_account_blocklist" "mod-platform-circleci" "pagerduty_integration_keys" "nonmp-account-ids")
            for del in ${delete[@]}
            do
              secrets=("${secrets[@]/$del}")
            done
            
            # Define the threshold in seconds (180 days)
            threshold=$((180 * 24 * 60 * 60))
            
            # Get the current timestamp in seconds
            current_timestamp=$(date +%s)
            
            # Loop through each secret,  check its last changed date and raise issue if required
            for secret in $secrets; do
              last_changed=$(aws secretsmanager list-secret-version-ids --secret-id $secret --region $AWS_REGION --query "Versions[?contains(VersionStages,'AWSCURRENT')].CreatedDate" --output text | sort -r | head -n 1)
              
              # If the secret has never been changed, set the last_changed date to 0
              if [ -z "$last_changed" ]; then
                last_changed=0
              fi
            
              # Calculate the age of the secret in seconds
              age=$((current_timestamp - $(date -d "$last_changed" +%s)))

              # Check if there is an existing open issue to rotate the secret
              open_issue_count=$(gh issue list -R ministryofjustice/modernisation-platform --state open --limit 500 --json title --jq "[.[] | select(.title | contains(\"Rotate $secret\"))] | length")
            
              # Check if the secret is older than the threshold and if there is no existing open issue to rotate it, raise a new issue
              if [ $age -gt $threshold ] && [ "$open_issue_count" -eq 0 ]; then
                echo "$secret secret is older than 180 days (age: $((age / (24 * 60 * 60))) days)"
                echo "Creating GitHub Issue to rotate $secret"
                gh issue create --title "Rotate $secret Credential" --label "security,kanban" --project "Modernisation Platform" --body "The secrets-rotation-reminder workflow has identified that the $secret credential requires rotation as it is close to or exceeding the threshold of 180 days. Consult the [documentation](https://user-guide.modernisation-platform.service.justice.gov.uk/runbooks/rotating-secrets.html#how-to-rotate-secrets) which describes the process for rotation."
              elif [ $age -gt $threshold ] && [ "$open_issue_count" -gt 0 ]; then
                echo "$secret secret is older than 180 days (age: $((age / (24 * 60 * 60))) days) but an issue has already been raised to address this"
              else 
                echo "The $secret secret has not been identified for rotation (age: $((age / (24 * 60 * 60))) days)"
              fi
            done