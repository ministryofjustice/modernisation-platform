---
name: Secrets Rotation Reminder
on:
    workflow_dispatch:
    schedule: 
        - cron: '30 9 * * *' # run at 9:30 daily

env:
    AWS_REGION: "eu-west-2"
    ENVIRONMENT_MANAGEMENT: ${{ secrets.MODERNISATION_PLATFORM_ENVIRONMENTS }}
    
permissions:
    id-token: write # This is required for requesting the JWT
    contents: read # This is required for actions/checkout
    
defaults:
    run:
        shell: bash

jobs:
    secrets-rotation-reminder:
        runs-on: ubuntu-latest
        steps:
          - name: Checkout Repository
            uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
    
          - name: Set Account Number
            run: echo "ACCOUNT_NUMBER=$(jq -r -e '.modernisation_platform_account_id' <<< $ENVIRONMENT_MANAGEMENT)" >> $GITHUB_ENV
    
          - name: Configure AWS Credentials
            uses: aws-actions/configure-aws-credentials@010d0da01d0b5a38af31e9c3470dbfdabdecca3a # v4.0.1
            with:
              role-to-assume: "arn:aws:iam::${{ env.ACCOUNT_NUMBER }}:role/github-actions"
              role-session-name: githubactionsrolesession
              aws-region: ${{ env.AWS_REGION }}
    
          - name: Run Secrets Rotation Reminder Script
            run: |
              # Get the list of secret names from AWS Secrets Manager
              secrets=$(aws secretsmanager list-secrets --region $AWS_REGION --query "SecretList[].Name" --output text)

              # Print secret names to logs
              echo $secrets

            env:
              SECRET: ${{ secrets.GITHUB_TOKEN }}
              GITHUB_REPOSITORY: ${{ secrets.GITHUB_REPOSITORY }}

