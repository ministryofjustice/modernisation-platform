name: Testing Environment Request Extraction

on:
  workflow_dispatch:
  push:
    branches:
      - issue/12227

permissions: read-all

jobs:
  test-extraction:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'

      - name: Create dummy issue body file
        run: |
          cat > issue_body.txt << 'EOF'
          ### Is this an existing AWS account?

          No

          ### Application Name

          test-application

          ### application

          test-app-tag

          ### business-unit

          HQ

          ### infrastructure-support

          test-support@example.com

          ### owner

          test-owner@example.com

          ### SSO Group Name

          test-sso-group

          ### Do you require isolated networking?

          No

          ### Slack Channel

          #test-slack-channel

          ### GitHub code owner team slug

          test-owners-team

          ### GitHub actions reviewer team slug

          test-reviewers-team

          ### Environments

          - [x] Development
          - [x] test
          - [ ] Preproduction
          - [x] Production

          ### Environment access level Development

          view-only

          ### Environment access level Test

          developer

          ### Environment access level Preproduction

          _No response_

          ### Environment access level Production

          view-only
          EOF
          
          echo "ISSUE_NUMBER=99999" >> $GITHUB_ENV

      - name: Extract fields from issue
        run: |
          # Function to extract and sanitize field values
          extract_field() {
            local key="$1"
            local value=$(awk -v k="$key" '$0==k {while(getline>0){if($0~/^$/)continue;if($0~/^_No response_$/){print "";exit}print $0;exit}}' issue_body.txt | xargs)
            # Sanitize: remove newlines/carriage returns, limit to 200 chars
            echo "$value" | tr -d '\n\r' | head -c 200
          }
          
          # Extract all fields
          EXISTING_ACCOUNT=$(extract_field "### Is this an existing AWS account?")
          APP_NAME=$(extract_field "### Application Name")
          APP_TAG=$(extract_field "### application")
          BUSINESS_UNIT=$(extract_field "### business-unit")
          INFRA_SUPPORT=$(extract_field "### infrastructure-support")
          OWNER=$(extract_field "### owner")
          SSO_GROUP=$(extract_field "### SSO Group Name")
          ISOLATED_ACCOUNT=$(extract_field "### Do you require isolated networking?")
          SLACK=$(extract_field "### Slack Channel")
          GITHUB_OWNERS=$(extract_field "### GitHub code owner team slug")
          GITHUB_REVIEWERS=$(extract_field "### GitHub actions reviewer team slug")
          
          # Write to GITHUB_ENV
          {
            echo "EXISTING_ACCOUNT=$EXISTING_ACCOUNT"
            echo "APP_NAME=$APP_NAME"
            echo "APP_TAG=$APP_TAG"
            echo "BUSINESS_UNIT=$BUSINESS_UNIT"
            echo "INFRA_SUPPORT=$INFRA_SUPPORT"
            echo "OWNER=$OWNER"
            echo "SSO_GROUP=$SSO_GROUP"
            echo "ISOLATED_ACCOUNT=$ISOLATED_ACCOUNT"
            echo "SLACK=$SLACK"
            echo "GITHUB_OWNERS=$GITHUB_OWNERS"
            echo "GITHUB_REVIEWERS=$GITHUB_REVIEWERS"
          } >> $GITHUB_ENV

      - name: Extract environment selections
        run: |
          ENVIRONMENTS=""

          # Development
          DEV_SELECTED=$(awk '/- \[x\] Development/ {print "true"}' issue_body.txt)
          DEV_ACCESS=$(awk -v key="### Environment access level Development" '
            $0==key {found=1; next}
            found && /^### / {exit}
            found && NF && $0!="_No response_" {print $0}
          ' issue_body.txt | paste -sd, -)
          if [ "$DEV_SELECTED" = "true" ]; then
            ENVIRONMENTS="${ENVIRONMENTS}{\"name\": \"development\", \"access_level\": \"$DEV_ACCESS\"},"
          fi

          # Test
          TEST_SELECTED=$(awk '/- \[x\] test/ {print "true"}' issue_body.txt)
          TEST_ACCESS=$(awk -v key="### Environment access level Test" '
            $0==key {found=1; next}
            found && /^### / {exit}
            found && NF && $0!="_No response_" {print $0}
          ' issue_body.txt | paste -sd, -)
          if [ "$TEST_SELECTED" = "true" ]; then
            ENVIRONMENTS="${ENVIRONMENTS}{\"name\": \"test\", \"access_level\": \"$TEST_ACCESS\"},"
          fi

          # Preproduction
          PREPROD_SELECTED=$(awk '/- \[x\] Preproduction/ {print "true"}' issue_body.txt)
          PREPROD_ACCESS=$(awk -v key="### Environment access level Preproduction" '
            $0==key {found=1; next}
            found && /^### / {exit}
            found && NF && $0!="_No response_" {print $0}
          ' issue_body.txt | paste -sd, -)
          if [ "$PREPROD_SELECTED" = "true" ]; then
            ENVIRONMENTS="${ENVIRONMENTS}{\"name\": \"preproduction\", \"access_level\": \"$PREPROD_ACCESS\"},"
          fi

          # Production
          PROD_SELECTED=$(awk '/- \[x\] Production/ {print "true"}' issue_body.txt)
          PROD_ACCESS=$(awk -v key="### Environment access level Production" '
            $0==key {found=1; next}
            found && /^### / {exit}
            found && NF && $0!="_No response_" {print $0}
          ' issue_body.txt | paste -sd, -)
          if [ "$PROD_SELECTED" = "true" ]; then
            ENVIRONMENTS="${ENVIRONMENTS}{\"name\": \"production\", \"access_level\": \"$PROD_ACCESS\"},"
          fi

          # Remove trailing comma and wrap in brackets
          ENV_SELECTIONS_JSON="[$(echo $ENVIRONMENTS | sed 's/,$//')]"
          echo "ENV_SELECTIONS_JSON=$ENV_SELECTIONS_JSON" >> $GITHUB_ENV

      - name: Display extracted values
        run: |
          echo "=== Extracted Fields ==="
          echo "EXISTING_ACCOUNT: $EXISTING_ACCOUNT"
          echo "APP_NAME: $APP_NAME"
          echo "APP_TAG: $APP_TAG"
          echo "BUSINESS_UNIT: $BUSINESS_UNIT"
          echo "INFRA_SUPPORT: $INFRA_SUPPORT"
          echo "OWNER: $OWNER"
          echo "SSO_GROUP: $SSO_GROUP"
          echo "ISOLATED_ACCOUNT: $ISOLATED_ACCOUNT"
          echo "SLACK: $SLACK"
          echo "GITHUB_OWNERS: $GITHUB_OWNERS"
          echo "GITHUB_REVIEWERS: $GITHUB_REVIEWERS"
          echo ""
          echo "=== Environment Selections ==="
          echo "ENV_SELECTIONS_JSON: $ENV_SELECTIONS_JSON"
