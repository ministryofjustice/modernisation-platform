name: "IAM Access Key & User Hygiene (DRY RUN) - Extended Matrix"

on:
  # First Monday of every month at 09:30
  schedule:
    - cron: "30 9 1-7 * 1"
  workflow_dispatch: {}

env:
  AWS_REGION: "eu-west-2"
  TEMPLATE_ID: "842554a5-a3bf-4905-ae4a-7c61a123267b"
  EXPECTED_TEMPLATE_VERSION: "1"
  # Optional (only needed when not using dry-run)
  # NOTIFY_RECIPIENT_EMAIL: "modernisation-platform-team@justice.gov.uk"

permissions:
  id-token: write
  contents: read

defaults:
  run:
    shell: bash

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  # -------------------------------------------------------------------------
  # Fetch secrets
  # -------------------------------------------------------------------------
  fetch-secrets:
    uses: ministryofjustice/modernisation-platform-github-actions/.github/workflows/aws-secrets-management.yml@0c879ebf9183dd7e47d3fe9c961afa3271843b8b # v3.6.0
    secrets:
      MODERNISATION_PLATFORM_ACCOUNT_NUMBER: ${{ secrets.MODERNISATION_PLATFORM_ACCOUNT_NUMBER }}
      PASSPHRASE: ${{ secrets.PASSPHRASE }}

  # -------------------------------------------------------------------------
  # Setup + build account list + build accounts_map (Name -> Id) ONCE
  # -------------------------------------------------------------------------
  setup-prerequisites:
    runs-on: ubuntu-latest
    needs: fetch-secrets
    outputs:
      aws-region: ${{ steps.setup-aws-region.outputs.aws-region }}
      matrix: ${{ steps.build-matrix.outputs.matrix }}
      accounts_map: ${{ steps.build-accounts-map.outputs.accounts_map }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Decrypt Secrets
        uses: ministryofjustice/modernisation-platform-github-actions/decrypt-secrets@0c879ebf9183dd7e47d3fe9c961afa3271843b8b # v3.6.0
        with:
          environment_management: ${{ needs.fetch-secrets.outputs.environment_management }}
          PASSPHRASE: ${{ secrets.PASSPHRASE }}

      - name: Set Root Account Number
        run: |
          ROOT_ACCOUNT_NUMBER="$(jq -r -e '.aws_organizations_root_account_id' <<< "$ENVIRONMENT_MANAGEMENT")"
          echo "::add-mask::$ROOT_ACCOUNT_NUMBER"
          echo "ROOT_ACCOUNT_NUMBER=$ROOT_ACCOUNT_NUMBER" >> "$GITHUB_ENV"

      - name: Configure AWS Credentials (root / org account)
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708 # v5.1.1
        with:
          role-to-assume: "arn:aws:iam::${{ env.ROOT_ACCOUNT_NUMBER }}:role/ModernisationPlatformGithubActionsRole"
          role-session-name: githubactionsrolesession
          aws-region: ${{ env.AWS_REGION }}

      - id: build-accounts-map
        name: Build accounts map from AWS Organizations (Name -> Id)
        run: |
          set -euo pipefail
          accounts_map="$(
            aws organizations list-accounts --output json \
              | jq -c '[.Accounts[] | select(.Status=="ACTIVE") | {key: .Name, value: .Id}] | from_entries'
          )"
          echo "Accounts map built with $(echo "$accounts_map" | jq 'length') entries"

          # Write as a multiline output to avoid JSON/quoting issues
          {
            echo "accounts_map<<EOF"
            echo "$accounts_map"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - id: build-matrix
        name: Build matrix (account names) from accounts map
        run: |
          set -euo pipefail
          matrix="$(jq -c 'keys | sort' <<< '${{ steps.build-accounts-map.outputs.accounts_map }}')"
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"

      - id: setup-aws-region
        name: Setup AWS Region output
        run: |
          echo "aws-region=$AWS_REGION" >> "$GITHUB_OUTPUT"

  # -------------------------------------------------------------------------
  # Split matrix into blocks
  # -------------------------------------------------------------------------
  define-jobs:
    runs-on: ubuntu-latest
    needs: setup-prerequisites
    env:
      account_list: ${{ needs.setup-prerequisites.outputs.matrix }}
    outputs:
      block_1: ${{ steps.split.outputs.block_1 }}
      block_2: ${{ steps.split.outputs.block_2 }}
      block_3: ${{ steps.split.outputs.block_3 }}
      block_4: ${{ steps.split.outputs.block_4 }}
    steps:
      - id: split
        run: |
          set -euo pipefail

          BLOCK_COUNT=4
          sorted="$(echo "$account_list" | jq -c 'sort')"
          total="$(echo "$sorted" | jq 'length')"
          base=$(( total / BLOCK_COUNT ))
          remainder=$(( total % BLOCK_COUNT ))
          start=0

          for i in $(seq 1 "$BLOCK_COUNT"); do
            key="block_$i"
            extra=0
            if [ "$i" -le "$remainder" ]; then
              extra=1
            fi
            end=$(( start + base + extra ))
            block="$(echo "$sorted" | jq ".[$start:$end]")"
            compact="$(echo "$block" | jq -c '.')"

            echo "::group::$key"
            echo "$block" | jq .
            echo "::endgroup::"

            echo "$key=$compact" >> "$GITHUB_OUTPUT"
            start=$end
          done

  # -------------------------------------------------------------------------
  # Per-account IAM hygiene (DRY RUN) – blocks 1–4
  # -------------------------------------------------------------------------

  iam-hygiene-1:
    needs: [fetch-secrets, setup-prerequisites, define-jobs]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        account_name: ${{ fromJSON(needs.define-jobs.outputs.block_1) }}
    env:
      ACCOUNTS_MAP: ${{ needs.setup-prerequisites.outputs.accounts_map }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Decrypt Secrets
        uses: ministryofjustice/modernisation-platform-github-actions/decrypt-secrets@0c879ebf9183dd7e47d3fe9c961afa3271843b8b # v3.6.0
        with:
          environment_management: ${{ needs.fetch-secrets.outputs.environment_management }}
          gov_uk_notify_api_key: ${{ needs.fetch-secrets.outputs.gov_uk_notify_api_key }}
          PASSPHRASE: ${{ secrets.PASSPHRASE }}

      - name: Set Root Account Number
        run: |
          ROOT_ACCOUNT_NUMBER="$(jq -r -e '.aws_organizations_root_account_id' <<< "$ENVIRONMENT_MANAGEMENT")"
          echo "::add-mask::$ROOT_ACCOUNT_NUMBER"
          echo "ROOT_ACCOUNT_NUMBER=$ROOT_ACCOUNT_NUMBER" >> "$GITHUB_ENV"

      - name: Configure AWS Credentials (root / org account)
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708 # v5.1.1
        with:
          role-to-assume: "arn:aws:iam::${{ env.ROOT_ACCOUNT_NUMBER }}:role/ModernisationPlatformGithubActionsRole"
          role-session-name: githubactionsrolesession
          aws-region: ${{ needs.setup-prerequisites.outputs.aws-region }}

      - name: Resolve member account ID (from prebuilt map)
        id: account
        run: |
          set -euo pipefail
          ACCOUNT_NUMBER="$(jq -er --arg name "${{ matrix.account_name }}" '.[$name]' <<< "$ACCOUNTS_MAP")"
          echo "::add-mask::$ACCOUNT_NUMBER"
          echo "account-number=$ACCOUNT_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Configure AWS Credentials (member account)
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708 # v5.1.1
        with:
          role-to-assume: "arn:aws:iam::${{ steps.account.outputs.account-number }}:role/github-actions-apply"
          role-session-name: githubactionsrolesession
          aws-region: ${{ needs.setup-prerequisites.outputs.aws-region }}

      - name: Run IAM access key & user hygiene (DRY RUN)
        env:
          TEMPLATE_ID: ${{ env.TEMPLATE_ID }}
          EXPECTED_TEMPLATE_VERSION: ${{ env.EXPECTED_TEMPLATE_VERSION }}
          GOV_UK_NOTIFY_API_KEY: ${{ needs.fetch-secrets.outputs.gov_uk_notify_api_key }}
        run: |
          bash ./scripts/iam-monitoring/inactive-keys-and-users/check_iam_users_and_keys.sh --dry-run

  iam-hygiene-2:
    needs: [fetch-secrets, setup-prerequisites, define-jobs]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        account_name: ${{ fromJSON(needs.define-jobs.outputs.block_2) }}
    env:
      ACCOUNTS_MAP: ${{ needs.setup-prerequisites.outputs.accounts_map }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Decrypt Secrets
        uses: ministryofjustice/modernisation-platform-github-actions/decrypt-secrets@0c879ebf9183dd7e47d3fe9c961afa3271843b8b # v3.6.0
        with:
          environment_management: ${{ needs.fetch-secrets.outputs.environment_management }}
          gov_uk_notify_api_key: ${{ needs.fetch-secrets.outputs.gov_uk_notify_api_key }}
          PASSPHRASE: ${{ secrets.PASSPHRASE }}

      - name: Set Root Account Number
        run: |
          ROOT_ACCOUNT_NUMBER="$(jq -r -e '.aws_organizations_root_account_id' <<< "$ENVIRONMENT_MANAGEMENT")"
          echo "::add-mask::$ROOT_ACCOUNT_NUMBER"
          echo "ROOT_ACCOUNT_NUMBER=$ROOT_ACCOUNT_NUMBER" >> "$GITHUB_ENV"

      - name: Configure AWS Credentials (root / org account)
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708 # v5.1.1
        with:
          role-to-assume: "arn:aws:iam::${{ env.ROOT_ACCOUNT_NUMBER }}:role/ModernisationPlatformGithubActionsRole"
          role-session-name: githubactionsrolesession
          aws-region: ${{ needs.setup-prerequisites.outputs.aws-region }}

      - name: Resolve member account ID (from prebuilt map)
        id: account
        run: |
          set -euo pipefail
          ACCOUNT_NUMBER="$(jq -er --arg name "${{ matrix.account_name }}" '.[$name]' <<< "$ACCOUNTS_MAP")"
          echo "::add-mask::$ACCOUNT_NUMBER"
          echo "account-number=$ACCOUNT_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Configure AWS Credentials (member account)
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708 # v5.1.1
        with:
          role-to-assume: "arn:aws:iam::${{ steps.account.outputs.account-number }}:role/github-actions-apply"
          role-session-name: githubactionsrolesession
          aws-region: ${{ needs.setup-prerequisites.outputs.aws-region }}

      - name: Run IAM access key & user hygiene (DRY RUN)
        env:
          TEMPLATE_ID: ${{ env.TEMPLATE_ID }}
          EXPECTED_TEMPLATE_VERSION: ${{ env.EXPECTED_TEMPLATE_VERSION }}
          GOV_UK_NOTIFY_API_KEY: ${{ needs.fetch-secrets.outputs.gov_uk_notify_api_key }}
        run: |
          bash ./scripts/iam-monitoring/inactive-keys-and-users/check_iam_users_and_keys.sh --dry-run

  iam-hygiene-3:
    needs: [fetch-secrets, setup-prerequisites, define-jobs]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        account_name: ${{ fromJSON(needs.define-jobs.outputs.block_3) }}
    env:
      ACCOUNTS_MAP: ${{ needs.setup-prerequisites.outputs.accounts_map }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Decrypt Secrets
        uses: ministryofjustice/modernisation-platform-github-actions/decrypt-secrets@0c879ebf9183dd7e47d3fe9c961afa3271843b8b # v3.6.0
        with:
          environment_management: ${{ needs.fetch-secrets.outputs.environment_management }}
          gov_uk_notify_api_key: ${{ needs.fetch-secrets.outputs.gov_uk_notify_api_key }}
          PASSPHRASE: ${{ secrets.PASSPHRASE }}

      - name: Set Root Account Number
        run: |
          ROOT_ACCOUNT_NUMBER="$(jq -r -e '.aws_organizations_root_account_id' <<< "$ENVIRONMENT_MANAGEMENT")"
          echo "::add-mask::$ROOT_ACCOUNT_NUMBER"
          echo "ROOT_ACCOUNT_NUMBER=$ROOT_ACCOUNT_NUMBER" >> "$GITHUB_ENV"

      - name: Configure AWS Credentials (root / org account)
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708 # v5.1.1
        with:
          role-to-assume: "arn:aws:iam::${{ env.ROOT_ACCOUNT_NUMBER }}:role/ModernisationPlatformGithubActionsRole"
          role-session-name: githubactionsrolesession
          aws-region: ${{ needs.setup-prerequisites.outputs.aws-region }}

      - name: Resolve member account ID (from prebuilt map)
        id: account
        run: |
          set -euo pipefail
          ACCOUNT_NUMBER="$(jq -er --arg name "${{ matrix.account_name }}" '.[$name]' <<< "$ACCOUNTS_MAP")"
          echo "::add-mask::$ACCOUNT_NUMBER"
          echo "account-number=$ACCOUNT_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Configure AWS Credentials (member account)
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708 # v5.1.1
        with:
          role-to-assume: "arn:aws:iam::${{ steps.account.outputs.account-number }}:role/github-actions-apply"
          role-session-name: githubactionsrolesession
          aws-region: ${{ needs.setup-prerequisites.outputs.aws-region }}

      - name: Run IAM access key & user hygiene (DRY RUN)
        env:
          TEMPLATE_ID: ${{ env.TEMPLATE_ID }}
          EXPECTED_TEMPLATE_VERSION: ${{ env.EXPECTED_TEMPLATE_VERSION }}
          GOV_UK_NOTIFY_API_KEY: ${{ needs.fetch-secrets.outputs.gov_uk_notify_api_key }}
        run: |
          bash ./scripts/iam-monitoring/inactive-keys-and-users/check_iam_users_and_keys.sh --dry-run

  iam-hygiene-4:
    needs: [fetch-secrets, setup-prerequisites, define-jobs]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        account_name: ${{ fromJSON(needs.define-jobs.outputs.block_4) }}
    env:
      ACCOUNTS_MAP: ${{ needs.setup-prerequisites.outputs.accounts_map }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Decrypt Secrets
        uses: ministryofjustice/modernisation-platform-github-actions/decrypt-secrets@0c879ebf9183dd7e47d3fe9c961afa3271843b8b # v3.6.0
        with:
          environment_management: ${{ needs.fetch-secrets.outputs.environment_management }}
          gov_uk_notify_api_key: ${{ needs.fetch-secrets.outputs.gov_uk_notify_api_key }}
          PASSPHRASE: ${{ secrets.PASSPHRASE }}

      - name: Set Root Account Number
        run: |
          ROOT_ACCOUNT_NUMBER="$(jq -r -e '.aws_organizations_root_account_id' <<< "$ENVIRONMENT_MANAGEMENT")"
          echo "::add-mask::$ROOT_ACCOUNT_NUMBER"
          echo "ROOT_ACCOUNT_NUMBER=$ROOT_ACCOUNT_NUMBER" >> "$GITHUB_ENV"

      - name: Configure AWS Credentials (root / org account)
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708 # v5.1.1
        with:
          role-to-assume: "arn:aws:iam::${{ env.ROOT_ACCOUNT_NUMBER }}:role/ModernisationPlatformGithubActionsRole"
          role-session-name: githubactionsrolesession
          aws-region: ${{ needs.setup-prerequisites.outputs.aws-region }}

      - name: Resolve member account ID (from prebuilt map)
        id: account
        run: |
          set -euo pipefail
          ACCOUNT_NUMBER="$(jq -er --arg name "${{ matrix.account_name }}" '.[$name]' <<< "$ACCOUNTS_MAP")"
          echo "::add-mask::$ACCOUNT_NUMBER"
          echo "account-number=$ACCOUNT_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Configure AWS Credentials (member account)
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708 # v5.1.1
        with:
          role-to-assume: "arn:aws:iam::${{ steps.account.outputs.account-number }}:role/github-actions-apply"
          role-session-name: githubactionsrolesession
          aws-region: ${{ needs.setup-prerequisites.outputs.aws-region }}

      - name: Run IAM access key & user hygiene (DRY RUN)
        env:
          TEMPLATE_ID: ${{ env.TEMPLATE_ID }}
          EXPECTED_TEMPLATE_VERSION: ${{ env.EXPECTED_TEMPLATE_VERSION }}
          GOV_UK_NOTIFY_API_KEY: ${{ needs.fetch-secrets.outputs.gov_uk_notify_api_key }}
        run: |
          bash ./scripts/iam-monitoring/inactive-keys-and-users/check_iam_users_and_keys.sh --dry-run
