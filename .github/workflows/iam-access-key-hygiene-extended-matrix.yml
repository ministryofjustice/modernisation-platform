name: "IAM Access Key & User Hygiene (DRY RUN) - Extended Matrix"

on:
  # First Monday of every month at 09:30
  schedule:
    - cron: "30 9 1-7 * 1"
  workflow_dispatch:

env:
  AWS_REGION: "eu-west-2"

permissions:
  id-token: write
  contents: read

defaults:
  run:
    shell: bash

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  # -------------------------------------------------------------------------
  # Fetch secrets
  # -------------------------------------------------------------------------
  fetch-secrets:
    uses: ministryofjustice/modernisation-platform-github-actions/.github/workflows/aws-secrets-management.yml@0c879ebf9183dd7e47d3fe9c961afa3271843b8b
    secrets:
      MODERNISATION_PLATFORM_ACCOUNT_NUMBER: ${{ secrets.MODERNISATION_PLATFORM_ACCOUNT_NUMBER }}
      PASSPHRASE: ${{ secrets.PASSPHRASE }}

  # -------------------------------------------------------------------------
  # Setup prerequisites:
  # - decrypt secrets
  # - build accounts_map.json ONCE and upload as artifact
  # - build TF workspace matrix
  #
  # NOTE: We still need AWS creds here to call organizations:list-accounts,
  # so we assume the CENTRAL GitHub OIDC role.
  # -------------------------------------------------------------------------
  setup-prerequisites:
    runs-on: ubuntu-latest
    needs: fetch-secrets
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      aws-region: ${{ steps.setup-aws-region.outputs.aws-region }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          fetch-depth: 0

      - name: Decrypt Secrets
        uses: ministryofjustice/modernisation-platform-github-actions/decrypt-secrets@0c879ebf9183dd7e47d3fe9c961afa3271843b8b
        with:
          environment_management: ${{ needs.fetch-secrets.outputs.environment_management }}
          PASSPHRASE: ${{ secrets.PASSPHRASE }}

      # Assume the central OIDC-enabled role
      - name: Configure AWS Credentials (central GitHub OIDC role)
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708
        with:
          role-to-assume: arn:aws:iam::348456244381:role/github-actions
          role-session-name: githubactionsrolesession
          aws-region: ${{ env.AWS_REGION }}

      - name: Build Organizations accounts map (Name -> Id) ONCE
        run: |
          set -euo pipefail
          aws organizations list-accounts --output json \
            | jq -c '[.Accounts[] | select(.Status=="ACTIVE") | { key: .Name, value: .Id }] | from_entries' \
            > accounts_map.json
          echo "Accounts map entries: $(jq 'length' accounts_map.json)"

      - name: Upload accounts map artifact
        uses: actions/upload-artifact@v4
        with:
          name: accounts-map
          path: accounts_map.json
          retention-days: 1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd
        with:
          terraform_version: "~1"
          terraform_wrapper: false

      - name: Terraform init (delegate-access)
        run: bash scripts/terraform-init.sh terraform/environments/bootstrap/delegate-access

      - id: set-matrix
        name: Build workspace matrix (delegate-access)
        run: |
          set -euo pipefail
          echo "matrix=$(terraform -chdir=terraform/environments/bootstrap/delegate-access workspace list \
            | sed -e 's/*//' -e 's/^[[:space:]]*//' -e '/default/d' -e '/^$/d' \
            | sort -u | jq -ncR '[inputs]')" >> "$GITHUB_OUTPUT"

      - id: setup-aws-region
        name: Setup AWS Region output
        run: |
          set -euo pipefail
          echo "aws-region=$AWS_REGION" >> "$GITHUB_OUTPUT"

  # -------------------------------------------------------------------------
  # Split matrix into 4 blocks
  # -------------------------------------------------------------------------
  define-jobs:
    runs-on: ubuntu-latest
    needs: setup-prerequisites
    env:
      account_list: ${{ needs.setup-prerequisites.outputs.matrix }}
    outputs:
      block_1: ${{ steps.split.outputs.block_1 }}
      block_2: ${{ steps.split.outputs.block_2 }}
      block_3: ${{ steps.split.outputs.block_3 }}
      block_4: ${{ steps.split.outputs.block_4 }}
    steps:
      - id: split
        run: |
          set -euo pipefail
          BLOCK_COUNT=4
          sorted=$(echo "$account_list" | jq -c 'sort')
          total=$(echo "$sorted" | jq 'length')
          base=$(( total / BLOCK_COUNT ))
          remainder=$(( total % BLOCK_COUNT ))
          start=0
          for i in $(seq 1 $BLOCK_COUNT); do
            key="block_$i"
            extra=0
            if [ "$i" -le "$remainder" ]; then extra=1; fi
            end=$(( start + base + extra ))
            block=$(echo "$sorted" | jq ".[$start:$end]")
            compact=$(echo "$block" | jq -c '.')
            echo "::group::$key"
            echo "$block" | jq .
            echo "::endgroup::"
            echo "$key=$compact" >> "$GITHUB_OUTPUT"
            start=$end
          done

  # -------------------------------------------------------------------------
  # Per-account IAM hygiene – blocks 1–4
  # -------------------------------------------------------------------------
  iam-hygiene-1:
    needs: [fetch-secrets, setup-prerequisites, define-jobs]
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        workspaces: ${{ fromJSON(needs.define-jobs.outputs.block_1) }}
    uses: ./.github/workflows/reusable-run-per-account-script.yml
    with:
      JOB_NAME: iam-hygiene-1
      AWS_REGION: ${{ needs.setup-prerequisites.outputs.aws-region }}
      environment_management: ${{ needs.fetch-secrets.outputs.environment_management }}
      TF_WORKSPACE: ${{ matrix.workspaces }}
      # <-- IMPORTANT: use the role that already trusts the central github-actions role
      ASSUME_ROLE_NAME: ModernisationPlatformAccess
      SCRIPT_COMMAND: |
        bash ./scripts/iam-monitoring/inactive-keys-and-users/check_iam_users_and_keys.sh --dry-run
    secrets:
      PASSPHRASE: ${{ secrets.PASSPHRASE }}

  iam-hygiene-2:
    needs: [fetch-secrets, setup-prerequisites, define-jobs]
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        workspaces: ${{ fromJSON(needs.define-jobs.outputs.block_2) }}
    uses: ./.github/workflows/reusable-run-per-account-script.yml
    with:
      JOB_NAME: iam-hygiene-2
      AWS_REGION: ${{ needs.setup-prerequisites.outputs.aws-region }}
      environment_management: ${{ needs.fetch-secrets.outputs.environment_management }}
      TF_WORKSPACE: ${{ matrix.workspaces }}
      ASSUME_ROLE_NAME: ModernisationPlatformAccess
      SCRIPT_COMMAND: |
        bash ./scripts/iam-monitoring/inactive-keys-and-users/check_iam_users_and_keys.sh --dry-run
    secrets:
      PASSPHRASE: ${{ secrets.PASSPHRASE }}

  iam-hygiene-3:
    needs: [fetch-secrets, setup-prerequisites, define-jobs]
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        workspaces: ${{ fromJSON(needs.define-jobs.outputs.block_3) }}
    uses: ./.github/workflows/reusable-run-per-account-script.yml
    with:
      JOB_NAME: iam-hygiene-3
      AWS_REGION: ${{ needs.setup-prerequisites.outputs.aws-region }}
      environment_management: ${{ needs.fetch-secrets.outputs.environment_management }}
      TF_WORKSPACE: ${{ matrix.workspaces }}
      ASSUME_ROLE_NAME: ModernisationPlatformAccess
      SCRIPT_COMMAND: |
        bash ./scripts/iam-monitoring/inactive-keys-and-users/check_iam_users_and_keys.sh --dry-run
    secrets:
      PASSPHRASE: ${{ secrets.PASSPHRASE }}

  iam-hygiene-4:
    needs: [fetch-secrets, setup-prerequisites, define-jobs]
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        workspaces: ${{ fromJSON(needs.define-jobs.outputs.block_4) }}
    uses: ./.github/workflows/reusable-run-per-account-script.yml
    with:
      JOB_NAME: iam-hygiene-4
      AWS_REGION: ${{ needs.setup-prerequisites.outputs.aws-region }}
      environment_management: ${{ needs.fetch-secrets.outputs.environment_management }}
      TF_WORKSPACE: ${{ matrix.workspaces }}
      ASSUME_ROLE_NAME: ModernisationPlatformAccess
      SCRIPT_COMMAND: |
        bash ./scripts/iam-monitoring/inactive-keys-and-users/check_iam_users_and_keys.sh --dry-run
    secrets:
      PASSPHRASE: ${{ secrets.PASSPHRASE }}
