name: Reusable - Run Script Per Account

on:
  workflow_call:
    inputs:
      JOB_NAME:
        required: true
        type: string
      AWS_REGION:
        required: true
        type: string
      environment_management:
        required: true
        type: string
      TF_WORKSPACE:
        required: true
        type: string
      ASSUME_ROLE_NAME:
        required: true
        type: string
      SCRIPT_COMMAND:
        required: true
        type: string

      GOV_UK_NOTIFY_API_KEY:
        required: false
        type: string
      TEMPLATE_ID:
        required: false
        type: string
      EXPECTED_TEMPLATE_VERSION:
        required: false
        type: string

      KEY_NOTIFY_DAYS:
        required: false
        type: string
      KEY_DISABLE_DAYS:
        required: false
        type: string
      KEY_DELETE_DAYS:
        required: false
        type: string

      USER_NOTIFY_DAYS:
        required: false
        type: string
      USER_DISABLE_DAYS:
        required: false
        type: string
      USER_DELETE_DAYS:
        required: false
        type: string

    secrets:
      PASSPHRASE:
        required: true

permissions:
  id-token: write
  contents: read

defaults:
  run:
    shell: bash

jobs:
  main:
    runs-on: ubuntu-latest
    name: "Job - ${{ inputs.JOB_NAME }} (${{ inputs.TF_WORKSPACE }})"

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Decrypt Secrets
        uses: ministryofjustice/modernisation-platform-github-actions/decrypt-secrets@5c713c93eea694829b1bd3f410d0b235053318ce
        with:
          environment_management: ${{ inputs.environment_management }}
          gov_uk_notify_api_key: ${{ inputs.GOV_UK_NOTIFY_API_KEY }}
          PASSPHRASE: ${{ secrets.PASSPHRASE }}

      - name: Resolve member account ID (from ENVIRONMENT_MANAGEMENT.account_ids)
        id: account
        run: |
          set -euo pipefail

          if [[ -z "${ENVIRONMENT_MANAGEMENT:-}" ]]; then
            echo "ENVIRONMENT_MANAGEMENT not set after decrypt-secrets" >&2
            exit 1
          fi

          ACCOUNT_ID="$(jq -er --arg name "${{ inputs.TF_WORKSPACE }}" '.account_ids[$name]' <<< "$ENVIRONMENT_MANAGEMENT")"
          echo "::add-mask::$ACCOUNT_ID"
          echo "account-id=$ACCOUNT_ID" >> "$GITHUB_OUTPUT"

      - name: Configure AWS Credentials (member account OIDC role)
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708
        with:
          role-to-assume: arn:aws:iam::${{ steps.account.outputs.account-id }}:role/${{ inputs.ASSUME_ROLE_NAME }}
          role-session-name: githubactionsrolesession
          aws-region: ${{ inputs.AWS_REGION }}
          role-skip-session-tagging: true

      - name: Install GOV.UK Notify client
        run: |
          python3 -m pip install --upgrade pip
          pip3 install notifications-python-client

      - name: Run script in member account
        env:
          TEMPLATE_ID: ${{ inputs.TEMPLATE_ID }}
          EXPECTED_TEMPLATE_VERSION: ${{ inputs.EXPECTED_TEMPLATE_VERSION }}

          KEY_NOTIFY_DAYS: ${{ inputs.KEY_NOTIFY_DAYS }}
          KEY_DISABLE_DAYS: ${{ inputs.KEY_DISABLE_DAYS }}
          KEY_DELETE_DAYS: ${{ inputs.KEY_DELETE_DAYS }}

          USER_NOTIFY_DAYS: ${{ inputs.USER_NOTIFY_DAYS }}
          USER_DISABLE_DAYS: ${{ inputs.USER_DISABLE_DAYS }}
          USER_DELETE_DAYS: ${{ inputs.USER_DELETE_DAYS }}
        run: |
          set -euo pipefail
          aws sts get-caller-identity
          ${{ inputs.SCRIPT_COMMAND }}
