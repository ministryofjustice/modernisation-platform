name: Reusable - Run Script Per Account

on:
  workflow_call:
    inputs:
      JOB_NAME:
        required: true
        type: string

      AWS_REGION:
        required: true
        type: string

      environment_management:
        required: true
        type: string

      TF_WORKSPACE:
        required: true
        type: string

      ASSUME_ROLE_NAME:
        required: true
        type: string

      SCRIPT_COMMAND:
        required: true
        type: string

    secrets:
      PASSPHRASE:
        required: true

permissions:
  id-token: write
  contents: read

defaults:
  run:
    shell: bash

jobs:
  main:
    runs-on: ubuntu-latest
    name: "Job - ${{ inputs.JOB_NAME }} (${{ inputs.TF_WORKSPACE }})"

    env:
      AWS_REGION: ${{ inputs.AWS_REGION }}
      TEMPLATE_ID: "842554a5-a3bf-4905-ae4a-7c61a123267b"
      EXPECTED_TEMPLATE_VERSION: "1"

    steps:
      - name: Log context
        run: |
          echo "JOB_NAME=${{ inputs.JOB_NAME }}"
          echo "TF_WORKSPACE=${{ inputs.TF_WORKSPACE }}"

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Decrypt Secrets
        uses: ministryofjustice/modernisation-platform-github-actions/decrypt-secrets@0c879ebf9183dd7e47d3fe9c961afa3271843b8b
        with:
          environment_management: ${{ inputs.environment_management }}
          PASSPHRASE: ${{ secrets.PASSPHRASE }}

      - name: Set Root Account Number
        run: |
          ROOT_ACCOUNT_NUMBER=$(jq -r -e '.aws_organizations_root_account_id' <<< "$ENVIRONMENT_MANAGEMENT")
          echo "::add-mask::$ROOT_ACCOUNT_NUMBER"
          echo ROOT_ACCOUNT_NUMBER=$ROOT_ACCOUNT_NUMBER >> $GITHUB_ENV

      - name: Configure AWS Credentials (org/root)
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708
        with:
          role-to-assume: arn:aws:iam::${{ env.ROOT_ACCOUNT_NUMBER }}:role/ModernisationPlatformGithubActionsRole
          role-session-name: githubactionsrolesession
          aws-region: ${{ env.AWS_REGION }}

      - name: Resolve member account ID (workspace name â†’ account name)
        id: account
        run: |
          ACCOUNT_ID="$(
            aws organizations list-accounts --output json \
              | jq -er --arg name "${{ inputs.TF_WORKSPACE }}" \
                '.Accounts[]
                 | select(.Status=="ACTIVE")
                 | select(.Name==$name)
                 | .Id'
          )"
          echo "::add-mask::$ACCOUNT_ID"
          echo account-id=$ACCOUNT_ID >> $GITHUB_OUTPUT

      - name: Configure AWS Credentials (member account)
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708
        with:
          role-to-assume: arn:aws:iam::${{ steps.account.outputs.account-id }}:role/${{ inputs.ASSUME_ROLE_NAME }}
          role-session-name: githubactionsrolesession
          aws-region: ${{ env.AWS_REGION }}

      - name: Run script in member account
        run: |
          aws sts get-caller-identity
          ${{ inputs.SCRIPT_COMMAND }}
