name: Reusable - Run Script Per Account

on:
  workflow_call:
    inputs:
      JOB_NAME:
        required: true
        type: string

      AWS_REGION:
        required: true
        type: string

      environment_management:
        required: true
        type: string

      TF_WORKSPACE:
        required: true
        type: string

      ASSUME_ROLE_NAME:
        required: true
        type: string
        description: "OIDC role name to assume in member accounts (must exist in every account)"

      SCRIPT_COMMAND:
        required: true
        type: string
        description: "Shell command(s) to run after assuming into the member account"

      # Base64 accounts map (replaces artifact)
      ACCOUNTS_MAP_B64:
        required: true
        type: string
        description: "Base64-encoded accounts_map.json passed from the caller workflow"

      # ---- GOV.UK Notify passed in from caller ----
      GOV_UK_NOTIFY_API_KEY:
        required: false
        type: string
        description: "GOV.UK Notify API key (optional; typically encrypted/wrapped until decrypted)"

      TEMPLATE_ID:
        required: false
        type: string

      EXPECTED_TEMPLATE_VERSION:
        required: false
        type: string

      # ---- Threshold overrides (optional) ----
      KEY_NOTIFY_DAYS:
        required: false
        type: string
      KEY_DISABLE_DAYS:
        required: false
        type: string
      KEY_DELETE_DAYS:
        required: false
        type: string

      USER_NOTIFY_DAYS:
        required: false
        type: string
      USER_DISABLE_DAYS:
        required: false
        type: string
      USER_DELETE_DAYS:
        required: false
        type: string

    secrets:
      PASSPHRASE:
        required: true

permissions:
  id-token: write
  contents: read

defaults:
  run:
    shell: bash

jobs:
  main:
    runs-on: ubuntu-latest
    name: "Job - ${{ inputs.JOB_NAME }} (${{ inputs.TF_WORKSPACE }})"

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Recreate accounts_map.json from base64 input
        run: |
          set -euo pipefail
          if [[ -z "${{ inputs.ACCOUNTS_MAP_B64 }}" ]]; then
            echo "ACCOUNTS_MAP_B64 input is empty" >&2
            exit 1
          fi
          echo '${{ inputs.ACCOUNTS_MAP_B64 }}' | base64 --decode > accounts_map.json
          test -s accounts_map.json

      - name: Decrypt Secrets
        uses: ministryofjustice/modernisation-platform-github-actions/decrypt-secrets@0c879ebf9183dd7e47d3fe9c961afa3271843b8b
        with:
          environment_management: ${{ inputs.environment_management }}
          gov_uk_notify_api_key: ${{ inputs.GOV_UK_NOTIFY_API_KEY }}
          PASSPHRASE: ${{ secrets.PASSPHRASE }}

      - name: Resolve member account ID (from accounts_map.json)
        id: account
        run: |
          set -euo pipefail
          if [[ ! -s accounts_map.json ]]; then
            echo "accounts_map.json missing or empty" >&2
            ls -la
            exit 1
          fi

          ACCOUNT_ID="$(jq -er --arg name "${{ inputs.TF_WORKSPACE }}" '.[$name]' accounts_map.json)"
          echo "::add-mask::$ACCOUNT_ID"
          echo "account-id=$ACCOUNT_ID" >> "$GITHUB_OUTPUT"

      - name: Configure AWS Credentials (member account OIDC role)
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708
        with:
          role-to-assume: arn:aws:iam::${{ steps.account.outputs.account-id }}:role/${{ inputs.ASSUME_ROLE_NAME }}
          role-session-name: githubactionsrolesession
          aws-region: ${{ inputs.AWS_REGION }}
          role-skip-session-tagging: true

      - name: Install GOV.UK Notify client
        run: |
          python3 -m pip install --upgrade pip
          pip3 install notifications-python-client

      - name: Run script in member account
        env:
          TEMPLATE_ID: ${{ inputs.TEMPLATE_ID }}
          EXPECTED_TEMPLATE_VERSION: ${{ inputs.EXPECTED_TEMPLATE_VERSION }}

          KEY_NOTIFY_DAYS: ${{ inputs.KEY_NOTIFY_DAYS }}
          KEY_DISABLE_DAYS: ${{ inputs.KEY_DISABLE_DAYS }}
          KEY_DELETE_DAYS: ${{ inputs.KEY_DELETE_DAYS }}

          USER_NOTIFY_DAYS: ${{ inputs.USER_NOTIFY_DAYS }}
          USER_DISABLE_DAYS: ${{ inputs.USER_DISABLE_DAYS }}
          USER_DELETE_DAYS: ${{ inputs.USER_DELETE_DAYS }}
        run: |
          set -euo pipefail
          aws sts get-caller-identity
          ${{ inputs.SCRIPT_COMMAND }}
