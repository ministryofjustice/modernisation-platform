name: Reusable - Run Script Per Account

on:
  workflow_call:
    inputs:
      JOB_NAME:
        required: true
        type: string

      AWS_REGION:
        required: true
        type: string

      environment_management:
        required: true
        type: string

      TF_WORKSPACE:
        required: true
        type: string

      ASSUME_ROLE_NAME:
        required: true
        type: string
        description: "Role name to assume in member accounts (must exist in every account)"

      SCRIPT_COMMAND:
        required: true
        type: string
        description: "Shell command(s) to run after assuming into the member account"

    secrets:
      PASSPHRASE:
        required: true

permissions:
  id-token: write
  contents: read

defaults:
  run:
    shell: bash

jobs:
  main:
    runs-on: ubuntu-latest
    name: "Job - ${{ inputs.JOB_NAME }} (${{ inputs.TF_WORKSPACE }})"

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Download accounts map artifact
        uses: actions/download-artifact@v4
        with:
          name: accounts-map

      - name: Decrypt Secrets
        uses: ministryofjustice/modernisation-platform-github-actions/decrypt-secrets@0c879ebf9183dd7e47d3fe9c961afa3271843b8b
        with:
          environment_management: ${{ inputs.environment_management }}
          PASSPHRASE: ${{ secrets.PASSPHRASE }}

      - name: Set Root Account Number (org/root)
        run: |
          set -euo pipefail
          ROOT_ACCOUNT_NUMBER="$(jq -r -e '.aws_organizations_root_account_id' <<< "$ENVIRONMENT_MANAGEMENT")"
          echo "::add-mask::$ROOT_ACCOUNT_NUMBER"
          echo "ROOT_ACCOUNT_NUMBER=$ROOT_ACCOUNT_NUMBER" >> "$GITHUB_ENV"

      - name: Configure AWS Credentials (org/root account)
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708
        with:
          role-to-assume: arn:aws:iam::${{ env.ROOT_ACCOUNT_NUMBER }}:role/ModernisationPlatformGithubActionsRole
          role-session-name: githubactionsrolesession
          aws-region: ${{ inputs.AWS_REGION }}

      - name: Resolve member account ID (from accounts_map.json)
        id: account
        run: |
          set -euo pipefail
          if [[ ! -s accounts_map.json ]]; then
            echo "accounts_map.json missing or empty" >&2
            ls -la
            exit 1
          fi

          ACCOUNT_ID="$(jq -er --arg name "${{ inputs.TF_WORKSPACE }}" '.[$name]' accounts_map.json)"
          echo "::add-mask::$ACCOUNT_ID"
          echo "account-id=$ACCOUNT_ID" >> "$GITHUB_OUTPUT"

      - name: Configure AWS Credentials (member account role)
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708
        with:
          role-to-assume: arn:aws:iam::${{ steps.account.outputs.account-id }}:role/${{ inputs.ASSUME_ROLE_NAME }}
          role-session-name: githubactionsrolesession
          aws-region: ${{ inputs.AWS_REGION }}
          # This step is role-chaining off the org/root credentials above
          role-chaining: true

      - name: Run script in member account
        run: |
          set -euo pipefail
          aws sts get-caller-identity
          ${{ inputs.SCRIPT_COMMAND }}
