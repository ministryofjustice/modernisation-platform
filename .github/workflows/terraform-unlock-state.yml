name: Terraform Unlock State

on:
  workflow_dispatch:
    inputs:
      component:
        description: 'Choose a component'
        required: true
        type: choice
        options:
            - github
            - pagerduty
            - single-sign-on
            - modernisation-platform-account
            - environments
            - bootstrap/delegate-access
            - bootstrap/member-bootstrap
            - bootstrap/single-sign-on
            - bootstrap/secure-baselines
      application_name:
        description: 'Application name (e.g., sprinkler). Required for bootstrap components or environments with app/env.'
        required: false
      environment:
        description: 'Environment name (e.g., development). Required for bootstrap components or environments with app/env.'
        required: false
      lock_id:
        description: 'Terraform lock ID (from plan/apply error)'
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  unlock:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Determine Terraform path and workspace
        id: setup
        run: |
          COMPONENT="${{ github.event.inputs.component }}"
          APP_NAME="${{ github.event.inputs.application_name }}"
          ENV="${{ github.event.inputs.environment }}"

          if [[ "$COMPONENT" == "github" || "$COMPONENT" == "pagerduty" || "$COMPONENT" == "single-sign-on" || "$COMPONENT" == "modernisation-platform-account" ]]; then
            echo "TF_PATH=terraform/$COMPONENT" >> $GITHUB_ENV
            echo "TF_WORKSPACE=default" >> $GITHUB_ENV
            echo "S3_LOCK_KEY=$COMPONENT/terraform.tfstate.tflock" >> $GITHUB_ENV

          elif [[ "$COMPONENT" == "environments" ]]; then
            if [[ -n "$APP_NAME" && -n "$ENV" ]]; then
              echo "TF_PATH=terraform/environments/$APP_NAME" >> $GITHUB_ENV
              echo "TF_WORKSPACE=${APP_NAME}-${ENV}" >> $GITHUB_ENV
              echo "S3_LOCK_KEY=environments/accounts/$APP_NAME/${APP_NAME}-${ENV}/terraform.tfstate.tflock" >> $GITHUB_ENV
            else
              echo "TF_PATH=terraform/environments" >> $GITHUB_ENV
              echo "TF_WORKSPACE=default" >> $GITHUB_ENV
              echo "S3_LOCK_KEY=environments/terraform.tfstate.tflock" >> $GITHUB_ENV
            fi

          elif [[ "$COMPONENT" == bootstrap/* ]]; then
            if [[ -z "$APP_NAME" || -z "$ENV" ]]; then
              echo "You must provide 'application_name' and 'environment' for bootstrap"
              exit 1
            fi
            BOOTSTRAP_COMPONENT="${COMPONENT#bootstrap/}"
            echo "TF_PATH=terraform/environments/$COMPONENT" >> $GITHUB_ENV
            echo "TF_WORKSPACE=${APP_NAME}-${ENV}" >> $GITHUB_ENV
            echo "S3_LOCK_KEY=environments/bootstrap/$BOOTSTRAP_COMPONENT/${APP_NAME}-${ENV}/terraform.tfstate.tflock" >> $GITHUB_ENV

          else
            echo "Unknown component: $COMPONENT"
            exit 1
          fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: "~1"
        
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@8df5847569e6427dd6c4fb1cf565c83acfa8afa7 # v6.0.0
        with:
          role-to-assume: "arn:aws:iam::${{ secrets.MODERNISATION_PLATFORM_ACCOUNT_NUMBER }}:role/github-actions-apply"
          role-session-name: githubactionsrolesession
          aws-region: "eu-west-2"

      - name: Terraform Init
        working-directory: ${{ env.TF_PATH }}
        run: terraform init

      - name: Check if lock file exists
        id: check_lock
        run: |
          echo "Checking for lock file at: s3://modernisation-platform-terraform-state/$S3_LOCK_KEY"
          
          if aws s3api head-object --bucket modernisation-platform-terraform-state --key "$S3_LOCK_KEY" 2>/dev/null; then
            echo "LOCK_EXISTS=true" >> $GITHUB_OUTPUT
            echo "Lock file exists, will proceed with unlock"
          else
            echo "LOCK_EXISTS=false" >> $GITHUB_OUTPUT
            echo "Lock file does not exist, already unlocked"
          fi

      - name: Force Unlock State
        if: steps.check_lock.outputs.LOCK_EXISTS == 'true'
        working-directory: ${{ env.TF_PATH }}
        run: terraform force-unlock -force ${{ github.event.inputs.lock_id }}

      - name: Lock already removed
        if: steps.check_lock.outputs.LOCK_EXISTS == 'false'
        run: |
          echo "âœ… The Terraform state lock has already been removed."
          echo "Lock ID ${{ github.event.inputs.lock_id }} is not present in the state."
