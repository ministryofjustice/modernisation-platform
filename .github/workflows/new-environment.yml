name: "Terraform: New environment"

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/new-environment.yml'
      - 'terraform/environments/*.tf'
      - 'environments/**.json'
      - 'terraform/environments/bootstrap/**'
      - '!**.md'
  pull_request:
    branches:
      - main
    types: [opened, edited, reopened, synchronize]
    paths:
      - '.github/workflows/new-environment.yml'
      - 'terraform/environments/*.tf'
      - 'environments/**.json'
  workflow_dispatch:

env:
  TF_IN_AUTOMATION: true
  AWS_REGION: "eu-west-2"
  ENVIRONMENT_MANAGEMENT: ${{ secrets.MODERNISATION_PLATFORM_ENVIRONMENTS }}
  API_KEY: ${{ secrets.GOV_UK_NOTIFY_API_KEY }}
  TEMPLATE_ID: "c529aa7e-685a-4907-90dd-ab93fc4791ef"

permissions:
  id-token: write # This is required for requesting the JWT
  contents: read # This is required for actions/checkout

defaults:
  run:
    shell: bash

jobs:
  environment_json_changes_notification:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0
      - name: Get modified JSON files
        id: environment_json_changes
        run: |
          files=$(git diff --name-only --diff-filter=M @^ -- 'environments/*.json' | uniq | sed 's#environments/##' | sed 's/\.json$//' | tr '\n' ',')
          echo "files=${files%,}" >> $GITHUB_OUTPUT
      - name: Install Python
        if: steps.environment_json_changes.outputs.files != ''
        uses: actions/setup-python@39cd14951b08e74b54015e9e001cdefcf80e669f # v5.1.1
        with:
          python-version: '3.10'
      - name: Install the client
        if: steps.environment_json_changes.outputs.files != ''
        run: pip install notifications-python-client
      - name: Send notification to Slack
        if: steps.environment_json_changes.outputs.files != ''
        run: |
          IFS=',' read -r -a files <<< "${{ steps.environment_json_changes.outputs.files }}"
          for file in $files; do
            FILE_PATH="https://github.com/${GITHUB_REPOSITORY}/blob/main/environments/${file}"
            slack_channel=$(jq -r '.tags["slack-channel"] // empty' "environments/$file")
            if [[ -z "$slack_channel" ]]; then
              echo "No Slack channel specified in the $file or the field does not exist. Skipping."
              continue
            fi
            echo "Slack channel found: $slack_channel"
            webhook_url=$(echo $SLACK_WEBHOOKS | jq -r --arg channel "$slack_channel" '.[$channel]')
            if [[  -z "$webhook_url" || "$webhook_url" == "null" ]]; then
              echo "No webhook URL found for channel $slack_channel. Skipping notification."
              continue
            fi
            echo "Webhook URL found for channel $slack_channel"
            PAYLOAD=$(cat <<EOF
            {
              "text": "The JSON file <${FILE_PATH}|${file}> has been changed."
            }
              EOF
            )
            curl -X POST -H 'Content-type: application/json' --data "$PAYLOAD" "$webhook_url"
          done
        env:
          SLACK_WEBHOOKS: ${{ secrets.SLACK_WEBHOOKS }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
      - name: Send notification to Email
        if: steps.environment_json_changes.outputs.files != ''
        run: |
          python ./scripts/json-changes-notifier.py ${{ steps.environment_json_changes.outputs.files }}