name: "Terraform: GitHub resources"

on:
  push:
    paths:
      - 'terraform/github/**'
      - '!**.md'
      - '.github/workflows/terraform-github.yml'
      - 'environments/**.json'
      - '.github/workflows/reusable_terraform_plan_apply.yml'
      - 'collaborators.json'
    branches:
      - main
  pull_request:
    paths:
      - 'terraform/github/**'
      - '!**.md'
      - '.github/workflows/terraform-github.yml'
      - 'environments/**.json'
      - '.github/workflows/reusable_terraform_plan_apply.yml'
      - 'collaborators.json'
    branches:
      - main
    types: [opened, edited, reopened, synchronize]
  schedule:
    # * is a special character in YAML so you have to quote this string
    # trigger every Saturday at 12:00am
    - cron: '0 12 * * 6'
  workflow_dispatch:

defaults:
  run:
    shell: bash

env:
  RATE_THRESHOLD: 100
  APP_ID: 2013696

permissions:
  id-token: write # This is required for requesting the JWT
  contents: read # This is required for actions/checkout
  pull-requests: write
  
jobs:

  fetch-secrets:
    uses: ministryofjustice/modernisation-platform-github-actions/.github/workflows/aws-secrets-management.yml@4eceb2a416a197e91dc557c2ef0b5dd9afe29e0c # v3.4.6
    secrets:
      MODERNISATION_PLATFORM_ACCOUNT_NUMBER: ${{ secrets.MODERNISATION_PLATFORM_ACCOUNT_NUMBER }}
      PASSPHRASE: ${{ secrets.PASSPHRASE }}  

  github-status-check:
    runs-on: ubuntu-latest
    needs: fetch-secrets
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
      - name: Decrypt Secrets
        uses: ministryofjustice/modernisation-platform-github-actions/decrypt-secrets@4eceb2a416a197e91dc557c2ef0b5dd9afe29e0c # v3.4.6
        with:
          mp_github_app_private_key: ${{ needs.fetch-secrets.outputs.mp_github_app_private_key }}
          slack_webhook_url: ${{ needs.fetch-secrets.outputs.slack_webhook_url }}
          PASSPHRASE: ${{ secrets.PASSPHRASE }}
      - name: Check GitHub status
        run: |
          response=$(curl -s https://www.githubstatus.com/api/v2/summary.json)

          # Check status of key components
          git_operations_status=$(echo "$response" | jq -r '.components[] | select(.name == "Git Operations") | .status')
          api_status=$(echo "$response" | jq -r '.components[] | select(.name == "API Requests") | .status')
    
          # Only fail if components are not operational
          if [ "$git_operations_status" = "operational" ] && [ "$api_status" = "operational" ]; then
            echo "GitHub components are operational"
          else
            echo "GitHub components not fully operational - Git Operations: $git_operations_status, API: $api_status"
            exit 1
          fi
      - name: Create GitHub App token
        id: app
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        with:
          app-id: ${{ env.APP_ID }}               
          private-key: ${{ env.MP_GITHUB_APP_PRIVATE_KEY }} 
          owner: "ministryofjustice"
          repositories: "modernisation-platform"
      - name: Authenticate GitHub CLI as the App and Check the Rate Usage
        env:
          GH_TOKEN: ${{ steps.app.outputs.token }}
        run: |
          # gh automatically uses GH_TOKEN if set â€” no `gh auth login` needed
          gh auth status
          bash ./scripts/check-github-api-usage.sh

  github-plan-and-apply:
    needs: [ github-status-check ]
    uses: ./.github/workflows/reusable_terraform_plan_apply.yml
    with:
      working-directory: "terraform/github"
      workflow_id: "github"
    secrets:
      MODERNISATION_PLATFORM_ACCOUNT_NUMBER: ${{ secrets.MODERNISATION_PLATFORM_ACCOUNT_NUMBER }}
      PASSPHRASE: ${{ secrets.PASSPHRASE }}

  create-github-environments:
    runs-on: ubuntu-latest
    needs: [ fetch-secrets, github-status-check, github-plan-and-apply ]
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          fetch-depth: 0 # or "2" To retrieve the preceding commit.
      - name: Decrypt Secrets
        uses: ministryofjustice/modernisation-platform-github-actions/decrypt-secrets@4eceb2a416a197e91dc557c2ef0b5dd9afe29e0c # v3.4.6
        with:
          mp_github_app_private_key: ${{ needs.fetch-secrets.outputs.mp_github_app_private_key }}
          slack_webhook_url: ${{ needs.fetch-secrets.outputs.slack_webhook_url }}
          PASSPHRASE: ${{ secrets.PASSPHRASE }}
      - name: Create GitHub App token
        id: app-envts
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        with:
          app-id: ${{ env.APP_ID }}               
          private-key: ${{ env.MP_GITHUB_APP_PRIVATE_KEY }} 
          owner: "ministryofjustice"
          repositories: "modernisation-platform-environments"
      - name: Authenticate GitHub CLI as the App
        env:
          GH_TOKEN: ${{ steps.app-envts.outputs.token }}
        run: |
          gh auth status
      - name: Create GitHub member environments plan
        env:
          DRY_RUN: true
          GH_TOKEN: ${{ steps.app-envts.outputs.token }}
        run: |
          bash ./scripts/git-create-environments.sh
      - name: Create GitHub member environments apply
        if: github.event.ref == 'refs/heads/main'
        run: bash ./scripts/git-create-environments.sh
        env:
          GH_TOKEN: ${{ steps.app-envts.outputs.token }}
      - name: Slack failure notification
        if: ${{ failure() }}
        uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a # v2.1.1
        with:
          webhook-type: incoming-webhook
          payload: |
            {"blocks":[{"type": "section","text": {"type": "mrkdwn","text": ":no_entry: Failed GitHub Action:"}},{"type": "section","fields":[{"type": "mrkdwn","text": "*Workflow:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|${{ github.workflow }}>"},{"type": "mrkdwn","text": "*Job:*\n${{ github.job }}"},{"type": "mrkdwn","text": "*Repo:*\n${{ github.repository }}"}]}]}
        env:
          SLACK_WEBHOOK_URL: ${{ env.SLACK_WEBHOOK_URL }}
