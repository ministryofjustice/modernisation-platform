name: Testing Signed Commits - New Files in MPEnvironments

on:
  workflow_dispatch:
  push:
    branches:
      - testing-signed-commits

permissions: {}

defaults:
  run:
    shell: bash

jobs:
  create-and-commit-files:
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          path: core-repo
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          repository: ministryofjustice/modernisation-platform-environments
          path: modernisation-platform-environments
          persist-credentials: false

      - name: Generate some changes to a terraform file
        run: |
            cd ./modernisation-platform-environments/terraform/environments/sprinkler
            pwd
            ls -ltra
            # Amend line 35 by adding a tab before the hash
            sed -i '35s/^/#/' platform_locals.tf
        shell: bash

      - name: Git Setup
        run: bash ./core-repo/scripts/git-setup.sh ./modernisation-platform-environments

      - name: Commit and Create PR with Signed Commit if Changes are Found
        uses: ministryofjustice/modernisation-platform-github-actions/signed-commit@63e401ea799fc04764c848fb8baa76a2b6d7d473 # TESTING
        with:
          git_path: "terraform/environments"
          github_token: ${{ secrets.GITHUB_TOKEN }}
          terraform_github_token: ${{ secrets.TERRAFORM_GITHUB_TOKEN }}
          remote_repository: "./modernisation-platform-environments"
          pr_title: "TESTING - New files for terraform/environments"
          pr_body: "> TESTING - This PR was automatically created via a GitHub action workflow ðŸ¤–"
        env:
          SECRET: ${{ secrets.GITHUB_TOKEN }}

